{# nations/nation_detail.html #}
{% extends "base.html" %} {# Make sure you have a base template #}

{% block title %}Nation: {{ nation.name }}{% endblock %}

{% block content %}
  <h1>{{ nation.name }}</h1>
  <p>{{ nation.description|linebreaks }}</p>

  <hr>

  <h2>Dominions 6 Mod Code Generation</h2>

  {# Display messages from the redirect (e.g., task started) #}
  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  {# Form to trigger generation #}
  {# Use POST method as it changes server state #}
  <form action="{% url 'nations:nation_generate_dm' nation.pk %}" method="post" style="margin-bottom: 1em;">
      {% csrf_token %}
      <button type="submit" {% if nation.generation_status == 'PENDING' or nation.generation_status == 'GENERATING' %}disabled{% endif %}>
          {% if nation.generation_status == 'PENDING' or nation.generation_status == 'GENERATING' %}
              Generation in Progress...
          {% else %}
              Generate DM Code (Async)
          {% endif %}
      </button>
  </form>

  <p><strong>Generation Status:</strong> {{ nation.get_generation_status_display }}</p>
  {% if nation.generation_task_id %}
      <p><small>Last Task ID: {{ nation.generation_task_id }}</small></p>
  {% endif %}

  {% if nation.generation_status == 'SUCCESS' %}
      <h3>Generated Code:</h3>
      <pre><code>{{ nation.generated_dm_code|default:"No code generated." }}</code></pre>
  {% elif nation.generation_status == 'FAILURE' %}
      <h3>Generation Failed:</h3>
      <p><strong>Error:</strong> {{ nation.generation_error|default:"Unknown error." }}</p>
      {% if nation.generated_dm_code %}
          <h4>Attempted Code Output:</h4>
          <pre><code>{{ nation.generated_dm_code }}</code></pre>
      {% endif %}
  {% elif nation.generation_status == 'PENDING' or nation.generation_status == 'GENERATING'%}
       <p>Generation is running in the background. Refresh this page in a minute or two to see the results.</p>
  {% elif nation.generation_status == 'NONE' %}
      <p>No generation attempted yet.</p>
  {% endif %}


  <hr>
  <a href="{% url 'nations:nation_update' nation.pk %}">Edit</a> |
  <a href="{% url 'nations:nation_delete' nation.pk %}">Delete</a> |
  <a href="{% url 'nations:nation_list' %}">Back to List</a>
{% endblock %}